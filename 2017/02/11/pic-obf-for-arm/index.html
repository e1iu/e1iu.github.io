<html>
<head>
	
	<title>PIC代码之移位</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<h3 id="PIC代码之移位"><a href="#PIC代码之移位" class="headerlink" title="PIC代码之移位"></a>PIC代码之移位</h3><p>对编译器已经生成的PIC代码进行混淆，其实还是很有意思的。关于什么是PIC代码可以看<a href="https://en.wikipedia.org/wiki/Position-independent_code" target="_blank" rel="external">这里</a>。我用ARM架构的thumb指令集来举例子。PIC代码与普通代码不同的地方在于，其代码中有很多是相对寻址。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0x00    ldr r1, [pc, #4]    ①</div><div class="line">...</div><div class="line">0x08    .word   0x0001      ②</div></pre></td></tr></table></figure>
<p>上面的代码①和②之间的距离必须是固定的８byte，因为语句①使用了pc做相对寻址，所以两条语句的相对位置一旦改变会导致语句①无法拿到语句②位置的常数１。</p>
<p>对于这种pc相关的代码，我们只要做相应的处理就可以。比如ldr指令，如果用pc相对寻址，那么所要寻找的常数是可以静态计算出来的，我们可以把上面的指令稍作变换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    push &#123;lr&#125;                   ①</div><div class="line">    bl G_0                      ②</div><div class="line">    .byte   0                   ③</div><div class="line">    .word   0x0001              ④</div><div class="line">    .byte   0                   ⑤</div><div class="line">G_0:</div><div class="line">    ldr r1, [lr, #0]            ⑥</div><div class="line">    pop &#123;lr&#125;                    ⑦</div></pre></td></tr></table></figure>
<p>语句①和语句⑦用于保存和恢复lr，因语句②会改变bl,并使lr寄存器为语句④的地址。语句③和⑤在此处略显奇怪，但仔细阅读<a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/third-party/archives/ddi0100e_arm_arm.pdf" target="_blank" rel="external">ARM的指令集手册</a>，可以看出这里是为了迎合bl指令的语义。</p>
<p>在编译器生成的PIC代码中，经常出现的pc相对寻址指令还有<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add r1, pc</div></pre></td></tr></table></figure></p>
<p>这种类型的指令明显也与pc的值相关，与ldr指令不同的是，add指令并没有读取常数,所以我们无法静态确定r1的值。如若改变指令运行时的位置，则由于pc的改变而导致add指令得出错误的r1。一个解决的思路是修复r1的值。虽然我们静态无法得到r1该为何值，但是我们静态计算出移位前后pc的差值δ。修复后的指令变为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">    push    &#123;lr&#125;                ①</div><div class="line">    bl  G_1                     ②</div><div class="line">    .byte   0                   ③</div><div class="line">    .word   0xffff7777          ④</div><div class="line">    .byte   0                   ⑤</div><div class="line">G_1:</div><div class="line">    ldr lr, [lr, #0]            ⑥</div><div class="line">    add r1, lr                  ⑦</div><div class="line">    add r1, pc                  ⑧</div><div class="line">    pop &#123;lr&#125;                    ⑨</div></pre></td></tr></table></figure>
<p>其中语句④即为移位前后pc的δ。⑦用于修复r1的值。</p>






</body>
</html>
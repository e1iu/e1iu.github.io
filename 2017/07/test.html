<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="../../js/frameworks.css" media="all" rel="stylesheet"/>
    <link href="../../js/github.css" media="all" rel="stylesheet"/>
    <title>Title</title>

</head>
<body>

<div class="container new-discussion-timeline experiment-repo-nav">

    <div class="gh-header">

        <h1 class="gh-header-title instapaper_title">Linux firewall</h1>
        <div class="gh-header-meta">
            qqq edited this page
            <relative-time datetime="2017-06-29T04:31:19Z">Jun 29, 2017</relative-time>
        </div>
    </div>
    <div id="wiki-content" class="wiki-content">
        <div id="wiki-body" class="wiki-body gollum-markdown-content instapaper_body">
            <div class="markdown-body">
                <h1>Overview</h1>
                <p>两种类型的防火墙：</p>
                <ol>
                    <li>packet filter</li>
                    <li>application filter</li>
                </ol>
                <h1>Lab Task</h1>
                <h2>Task1</h2>
                <p>利用ufw进行防火墙配置</p>
                <p>用seed作为虚拟机A,需要另外一个虚拟机B</p>
                <h3>Prevent A from doing telnet to Machine B</h3>
                <p>在seed里面无法用telnet连接到任何一台机器，原因未知，待解决。</p>
                <p><strong>原因找到，　seed中默认开启了telnet服务，我自己的机器默认没有开启telnet服务。　<a
                        href="https://stackoverflow.com/questions/34389620/telnet-unable-to-connect-to-remote-host-connection-refused">解决方法</a></strong>
                </p>
                <h3> Prevent B from doing telnet to Machine A.</h3>
                <p>在seed中使用ufw配置防火墙</p>
                <p>使用：</p>
                <pre><code>sudo ufw reject telent
                </code></pre>
                <p>可以拒绝一切telnet请求。</p>
                <p>ufw deny与reject的区别:refect会返回一个reject信息。deny从实验现象看是直接将请求包丢弃。</p>
                <p>拒绝特定机器B的telnet</p>
                <pre><code>sudo ufw reject proto tcp from B'ip to any port 23
                </code></pre>
                <p>实验后机器B无法用telnet连接A,但是物理机C仍然可以。</p>
                <h3>
                    Prevent A from visiting an external web site. You can choose any web site that you like to
                    block, but keep in mind, some web servers have multiple IP addresses
                </h3>
                <p>选取网站www.ustc.edu.cn 进行屏蔽。</p>
                <ol>
                    <li>使用ping查看目标的ip地址。</li>
                    <li>sudo ufw reject out to '目标ip'</li>
                </ol>
                <p>reject和deny都可以起到屏蔽的作用。通过实验观察，deny使得浏览器一直尝试请求页面，reject浏览器会立刻返回连接不可用的提示。</p>
                <h2>Task2</h2>
                <p>按照实验文档3.1的提示，编写一个简单的LKM.</p>
                <p>实验结果：</p>
                <p>在我的物理机上，当执行<code>sudo insmod hello.ko</code>时，syslog中出现Hello World.符合预期。当执行<code>sudo rmmod
                    hello</code>时，syslog中并没有出现Bye-bye World，　而是当第二次装载模块时，会将Bye-bye World和Hello World一起写在log上。
                </p>
                <p>在虚拟机seed中，syslog没有记录，但是通过<code>lsmod</code>查看，模块的确是装载了。</p>
                <h2>Task3</h2>
                <p>先配置seed环境。</p>
                <ol>
                    <li>利用ufw阻止一切对外的telnet请求 sudo ufw reject out telnet</li>
                    <li>利用ufw阻止对　www.ustc.edu.cn　的网络访问 sudo ufw reject out to '目标IP'</li>
                </ol>
                <p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/">关于ssh</a></p>
                <h3>Task3.a</h3>
                <p>虚拟机中为seed，作为机器A,物理机为机器B。</p>
                <p>在seed中使用ssh配置转发端口</p>
                <pre><code>ssh -L 8000:B's IP:23 username@B's IP
                </code></pre>
                <p>此命令将机器B作为代理，将本地端口８０００收到的请求发到机器B,机器B会再将请求发到机器B的端口２３. 实验文档的命令</p>
                <pre><code>ssh -L 8000:C's IP:23 username@B's IP
                </code></pre>
                <p>B会将收到的请求转发的机器C的２３端口。</p>
                <p>试验后从seed中使用telnet连接物理机器A成功。通过ws抓包观察，通信使用的是SSH协议。</p>
                <h3>Task3.b</h3>
                <p>实验目的是让seed可以访问被防火墙禁止的　www.ustc.edu.cn</p>
                <p>一种做法是与上面类似的命令</p>
                <pre><code>ssh -L 8000:USTC's IP:80 username@B's IP
                </code></pre>
                <p>实验中介绍了另一种做法：</p>
                <pre><code>ssh -D 9000 username@B's IP
                </code></pre>
                <p>
                    这种做法将本地端口９０００接受的请求发往代理机器B，问题是没有告诉B如何转发。原因是有些请求包中带有相关的信息，代理服务器可以从包中获取到相关信息然后自动转发。不过用这种动态的方法无法实现telnet。</p>
                <h3>Task 4</h3>
                <p>应用层防火墙与传输层防火墙的区别。</p>
                <h4>Task4.a Using squid</h4>
                <p>实验要求２台机器。机器A为虚拟机seed，用物理机作为机器B。在机器B上安装squid3</p>
                <pre><code>sudo apt-get install squid3
                </code></pre>
                <p>然后启动squid。默认情况下，squid会屏蔽所有http请求。具体可以查看squid的配置文件(/etc/squid/squid.conf)。</p>
                <p>在seed中设置firefox的代理。squid默认端口为3128。</p>
                <p>
                    由于代理默认拒绝所有http请求，所以浏览器得到了一个代理返回的界面。如果没有得到代理返回的界面，说明代理配置有问题。可能是浏览器代理配置错了，或者是机器B上的squid服务没有开启。</p>
                <p><strong>注：　可以通过lsof -i:3128来查看端口的使用情况</strong></p>
                <p>实验文档中要求配置代理，使之只能访问google。改为只能访问USTC。</p>
                <p>更改机器B的squid的配置文件。
                    在acl标签处定义一个新的acl。</p>
                <pre><code>acl myacl dst 218.22.21.21
                </code></pre>
                <p>在http_access标签处加入新的规则：</p>
                <pre><code>http_access allow myacl
                </code></pre>
                <p>在seed的浏览器中实验，只能访问USTC。</p>
                <p>在使用ufw屏蔽USTC的情况下，使用squid代理可以访问。web proxy工作在应用层。当ufw收到packet时，IP已经变为代理服务器的IP。</p>
                <h3>总结</h3>
                <p>重点是理解防火墙的工作原理。</p>
                <p>Organizations, Internet Service Providers (ISPs), and countries often block their internal
                    users from access-
                    ing certain external sites. This is called <strong>egress filtering</strong></p>

            </div>

            <!--<div id="wiki-footer" class="wiki-footer">-->
            <!--<a href="/qc1iu/simple-net/wiki/_new?wiki%5Bname%5D=_Footer" class="wiki-empty-box"><svg aria-hidden="true" class="octicon octicon-plus" height="16" version="1.1" viewBox="0 0 12 16" width="12"><path fill-rule="evenodd" d="M12 9H7v5H5V9H0V7h5V2h2v5h5z"/></svg> Add a custom footer</a>-->
            <!--</div>-->
        </div>
    </div>
</div>

<div class="modal-backdrop js-touch-events"></div>
</div>


</body>
</html>
